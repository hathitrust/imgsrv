<VirtualHost *:80>
	DocumentRoot /htapps/babel
	ServerName default.dev
  ServerAlias docker.local
  RewriteEngine On

	<Directory /htapps/babel/imgsrv>
      Options Indexes FollowSymLinks
      AllowOverride All
    Order Allow,Deny
    Allow from all
  </Directory>

  <DirectoryMatch /htapps/babel/imgsrv/cgi>
    Options +ExecCGI
    SetHandler cgi-script
    AllowOverride None
    Require all granted
  </DirectoryMatch>

  <Location />
    Order Allow,Deny
    Allow from all
  </Location>

  ProxyFCGISetEnvIf "true" SDRROOT "%{env:SDRROOT}"
  ProxyFCGISetEnvIf "true" SDRDATAROOT "%{env:SDRDATAROOT}"
  ProxyFCGISetEnvIf "true" HT_DEV "%{env:HT_DEV}"
  ProxyFCGISetEnvIf "reqenv('REQUEST_URI') =~ m,/cgi/imgsrv/(image|thumbnail|meta|html|ocr|cover)," PATH_INFO "$1"
  ProxyFCGISetEnvIf "reqenv('REQUEST_URI') =~ m,/cgi/imgsrv/(image|thumbnail|meta|html|ocr|cover)," SCRIPT_FILENAME "/cgi/imgsrv"
  ProxyFCGISetEnvIf "reqenv('REQUEST_URI') =~ m,/cgi/imgsrv/(image|thumbnail|meta|html|ocr|cover)," SCRIPT_URL "/cgi/imgsrv/$1"
  ProxyFCGISetEnvIf "reqenv('REQUEST_URI') =~ m,/cgi/imgsrv/(image|thumbnail|meta|html|ocr|cover)," SCRIPT_NAME "/cgi/imgsrv"

  # SetEnvIf ^/cgi REQUEST_URI SDRROOT="%{env:SDRROOT}"
  # SetEnvIf ^/cgi REQUEST_URI  SDRDATAROOT="%{env:SDRDATAROOT}"
  # SetEnvIf ^/cgi REQUEST_URI  HT_DEV=%{env:HT_DEV}"

  SetEnv SDRROOT /htapps/babel
  SetEnv SDRDATAROOT /sdr1
  SetEnv HT_DEV roger
  
  ProxyPassMatch "/cgi/imgsrv/(image|thumbnail|meta|html|ocr|cover)" "fcgi://imgsrv:31028/$1"

  RewriteCond %{DOCUMENT_ROOT}/$1/web/$2 -f
  RewriteRule ^/([^/]+)/(.*)       /$1/web/$2        [last]

  RewriteCond %{DOCUMENT_ROOT}/$2/cgi/$3 -f
  RewriteRule /(cgi)/([^/]+)/([^/]+)(.*)$  /$2/cgi/$3$4        [skip]

  RewriteCond %{DOCUMENT_ROOT}/$2/cgi/$2 -f
  RewriteRule ^/(cgi)/([^/]+)(.*)$    /$2/cgi/$2$3


  ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>